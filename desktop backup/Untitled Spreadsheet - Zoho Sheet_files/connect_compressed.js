function selectToolbar(e,o,n){var t=getSelectedElemnt(o,n);e.find("span").removeClass("active"),t.length&&J.each(t,function(o,n){e.find("[purpose="+n+"]").addClass("active")})}function getSelectedElemnt(e,o){var n=[],t=rng.endContainer,i=rng.startContainer;return 0===t.textContent.replace("​","").length&&(t=t.previousSibling,t||(t=i)),(i===rng.endContainer||i.parentNode===t||i.parentNode===t.parentNode)&&(text(e,o,n),parentNodes(e,o,n)),n}function text(e,o,n){var t;if(e===o)return n;if(e){if(!e.tagName)return n;if((t=e.childNodes)&&(n.push(tags[e.tagName]),1===t.length)){var i=t[0];return text(i,o,n)}}}function getLastTextNode(e){if(e&&1===e.nodeType&&"BR"!==e.nodeName){var o=e.childNodes;return o&&o.length?getLastTextNode(o[o.length-1]):e}return e}function parentNodes(e,o,n){return e===o?n:e?e.tagName?e.childNodes>1?n:(n.push(tags[e.tagName]),parentNodes(e.parentNode,o,n)):parentNodes(e.parentNode,o,n):void 0}function editorHeaderPosition(e,o){if(rng&&!isFixedHeaderToolbar){var n=o.attr("isWidgetEditorHeader");if(n||!rng)return;var t=rng.getClientRects(),i=0,r=0;t.length&&(i=t[0].left,r=t[0].top);var d=o.height(),s=o.is("[isFlyout=true]"),a=J(s?"#flyoutViewer":"#mainContainer"),l=0;if(s){var c=J("#scrollableArea");l=c[0].scrollTop-parseInt(c.css("padding-top").split("px")[0]),r=r+l-83}else l=a.scrollTop(),r=r+l-52;r>d&&(r-=d);var p=s?J("#flyoutViewer").position().left:J("#leftMenuContainer").width();if(i-=p,window.innerWidth-p<i){var u=i-o.width();u>0&&(i=u)}o.css("left",i),o.css("z-index","999"),o.css("top",r)}}function addRichHeader(e,o,n,t){if("task"===t||"event"===t)return o.closest("[purpose=cmtEditor]").removeClass("EditToolSpace"),o.attr("isTextEditor","true"),void taskEditorKeyDownPreventFormatting(o,o.closest("[purpose=singleTaskPopupElement]"));if("file_feed"===t)return o.closest("[purpose=cmtEditor]").removeClass("EditToolSpace"),void taskEditorKeyDownPreventFormatting(o,o.closest("[purpose=cmtEditor]"));var i=1===o.closest("#flyoutViewer").length;if(e=e+"_header"+(i?"popup":""),!J("#"+e).length){var r=$editorTemplate.find("[purpose=editorHeader]").clone().attr("id",e).attr("isFlyout",i).show();if(isFixedHeaderToolbar=!0)e.indexOf("pollEditor_header")>-1||e.indexOf("quickPollEditor_header")>-1?o.closest("[purpose='pollCont']").append(r):r.insertAfter(o),-1===e.indexOf("pollEditorInWidget_header")&&-1===e.indexOf("widgetPollEditEditor_header")&&r.css({width:"100%"}),r.removeClass("darkEditorToolbar").addClass("fixedToolbar");else{var d=J(i?"#flyoutViewer":"#mainContainer");d.append(r.hide()),r.find("[purpose='markdownIcon'],[purpose='embedImageIcon']").hide()}o.attr("headerId",e),r.attr("editorId",o.attr("id")),(e.indexOf("pollEditorInWidget_header")>-1||e.indexOf("widgetPollEditEditor_header")>-1)&&r.find("[purpose='markdownIcon']").hide(),bindRichText(r,o,n,t)}}function scrollIfEnd(e,o){var n=o.style.maxHeight;if(n&&"none"!==n&&parseInt(n.split("px")[0])>=o.height()+20){var t=e.scrollTop(),i=e.height(),r=i-o.height()-o.offset().top-(e.is("#scrollableArea")?0:wmstoolbarHeight+30);r=isFixedHeaderToolbar?r-30:r,0>r&&e.animate({scrollTop:t+Math.abs(r)},5)}}function disableEditorHeaderLi(e,o,n,t){detectTag(o,e,["BLOCKQUOTE"])?n.find("[purpose=embedImageIcon]").addClass("disabled"):detectTag(o,e,["CODE"])?disableCodeFunc(n):detectTag(o,e,["OL","UL","LI"])?(removeDisabledEditorHeaderContent(n),n.find("[purpose=embedImageIcon]").addClass("disabled"),t||n.find("[purpose=blockcode]").addClass("disabled")):removeDisabledEditorHeaderContent(n)}function disableEditorHeaderLiFromClass(e,o,n){o.is("[purpose=blockcode]")&&o.hasClass("active")?e.find("[purpose=embedImageIcon]").addClass("disabled"):o.is("[purpose=code]")&&o.hasClass("active")?disableCodeFunc(e):(o.is("[purpose=bullet]")||o.is("[purpose=number]"))&&o.hasClass("active")?(removeDisabledEditorHeaderContent(e),e.find("[purpose=embedImageIcon]").addClass("disabled"),n||e.find("[purpose=blockcode]").addClass("disabled")):removeDisabledEditorHeaderContent(e)}function disableCodeFunc(e){e.find("[purpose=bullet]").addClass("disabled"),e.find("[purpose=number]").addClass("disabled"),e.find("[purpose=link]").addClass("disabled"),e.find("[purpose=blockcode]").addClass("disabled"),e.find("[purpose=embedImageIcon]").addClass("disabled")}function removeDisabledEditorHeaderContent(e){e.find("[purpose=bullet]").removeClass("disabled"),e.find("[purpose=number]").removeClass("disabled"),e.find("[purpose=link]").removeClass("disabled"),e.find("[purpose=code]").removeClass("disabled"),e.find("[purpose=blockcode]").removeClass("disabled"),e.find("[purpose=embedImageIcon]").removeClass("disabled")}function bindRichText(e,o,n,t){var i=null,r=e.is("[isFlyout=true]");i=n?J("task"===t?"#singleTaskContainer":"#newEventInCalendar"):"article"===t?o.closest("[purpose='mArticleComment']").find("[purpose='commentList']"):J(r?"#scrollableArea":"#mainContainer");{var d=o.closest("[purpose='composeCont']");o.closest("[purpose='cmtEditor']")}wmstoolbarHeight&&0!==wmstoolbarHeight||(wmstoolbarHeight=J("#wmstoolbar").height());var s=!e.attr("isWidgetEditorHeader");J(o).bind("blur",function(){!e.is(":hover")&&s&&(e.find("[purpose=pasteLink]").hide(),e.find("[purpose=changeLinkPopup]").hide(),isFixedHeaderToolbar||e.hide())}),J(e).find("[purpose=linkContent]").unbind("blur").bind("blur",function(){!e.is(":hover")&&s&&(e.find("[purpose=pasteLink]").hide(),e.find("[purpose=changeLinkPopup]").hide(),isFixedHeaderToolbar||e.hide())}),J(o).unbind("click").bind("click",function(e){return J(e.target).is("a")?(e.preventDefault(),!1):void 0}),J(o).bind("focus input keyup mouseup",function(n){("focus"===n.type||"mouseup"===n.type)&&(o.innerHTML.length||(o.innerHTML="​",o.focus())),sel=document.selection?document.selection:document.getSelection();var t=J.trim(sel.toString());try{rng=sel.getRangeAt(0)}catch(e){rng=document.createRange()}if(("focus"===n.type||"mouseup"===n.type)&&setEditorMaxHeight(o,!1,!0),s)if(isFixedHeaderToolbar=!0){"focus"===n.type&&e.show();var i=e.attr("id");-1===i.indexOf("pollEditorInWidget_header")&&-1===i.indexOf("widgetPollEditEditor_header")&&e.css({width:"100%"}),J(o).closest("[purpose='cmtEditor']").removeClass("EditToolSpace").addClass("EditToolSpace"),J(o).closest("[purpose='composeCont']").removeClass("EditToolSpace").addClass("EditToolSpace")}else 0===t.length?e.hide():editorHeaderPosition(sel,e);var r=o[0],d=selectedEle(sel,r);if(d){var a=d.parentNode;if(a){var l=e.find("[purpose=embedVideoIcon]");a.className.indexOf("mention")>-1||"DIV"===a.nodeName?l.removeClass("disabled"):l.addClass("disabled")}rng.startOffset!==rng.endOffset||rng.startContainer!==rng.endContainer?(selectToolbar(e,d,r),disableEditorHeaderLi(r,d,e,0!==t.length),s&&e.show()):s&&(e.is(":hover")||(e.find("[purpose=pasteLink]").hide(),e.find("[purpose=changeLinkPopup]").hide()),e.find("[purpose=changeLinkPopup]").attr("isClicked")?(e.find("[purpose=changeLinkPopup]").show(),isFixedHeaderToolbar||e.show()):isFixedHeaderToolbar?e.show():e.is(":hover")||isFixedHeaderToolbar||0!==t.length||(e.find("[purpose=pasteLink]").hide(),e.hide()),("mouseup"===n.type||37===n.keyCode||38===n.keyCode||39===n.keyCode||40===n.keyCode||8===n.keyCode||27===n.keyCode||17===n.keyCode||13===n.keyCode)&&(selectToolbar(e,d,r),disableEditorHeaderLi(r,d,e,0!==t.length)))}}),J(o).bind("mouseup",function(){var n=o[0],t=selectedEle(sel,n),i=J.trim(document.getSelection().toString());if(e.find("[purpose=changeLinkPopup]").removeAttr("isClicked"),s&&!isFixedHeaderToolbar&&editorHeaderPosition(sel,e),detectTag(t,n,["A"])&&""!==t.textContent&&0===i.length){var r=e.find("[purpose=changeLinkPopup]");e.show(),r.attr("isClicked",!0).show();var d=t.parentNode.href;r.find("a").attr("href",d).html(d)}else 0!==i.length?(e.show(),e.find("[purpose=changeLinkPopup]").hide()):s&&!isFixedHeaderToolbar&&e.hide()}),J(o).bind("keyup keydown focus mouseup",function(e){sel=document.selection?document.selection:document.getSelection(),sel.type&&"None"!==sel.type&&(rng=sel.getRangeAt(0)),"keyup"===e.type&&13===e.keyCode&&scrollPositionToFocus(o)}),J(o).bind("keydown",function(n){sel=document.selection?document.selection:document.getSelection();var t=J.trim(sel.toString());if(!isFixedHeaderToolbar&&0===t.length&&s&&e.hide(),s&&scrollIfEnd(i,o),rng=sel.getRangeAt(0),n.ctrlKey||n.metaKey){var r=String.fromCharCode(n.keyCode).toLowerCase(),d=null;switch(r){case"b":d="strong";break;case"i":d="em";break;case"u":d=n.shiftKey?"bullet":"underline";break;case"o":d=n.shiftKey?"number":void 0}if(d)return e.find("[purpose="+d+"]").trigger("click"),n.preventDefault(),!1}else e.find(".editorHeaderParent").removeAttr("clicked");e.find("[purpose='markdownHelp']").hide()}),J(e).find("[purpose=embedImageIcon]").unbind("click").click(function(){var n=o[0],t=selectedEle(sel,n);if(!detectTag(t,n,["BLOCKQUOTE","CODE","A","OL","UL","LI"])){var i=document.createRange();i.setEnd(rng.endContainer,rng.endOffset),i.setStart(rng.startContainer,rng.startOffset),sel.removeAllRanges(),sel.addRange(i),o.focus();var r=e.find("[purpose='streamImageEmbed']");r.trigger("click"),r.unbind("change").bind("change",function(e){var o=J(this)[0].files;if(o.length>10)return void showMessageStrip(getI18NVal("connect.common.maxTotalFiles"),"failureMsg");for(var n=0;n<o.length;n++){(new Date).getTime()+n}r.val(""),e.preventDefault()})}}),J(e).unbind("click").click(function(n){if(!J(n.target).is("input")){var t=document.createRange();t.setEnd(rng.endContainer,rng.endOffset),t.setStart(rng.startContainer,rng.startOffset),sel.removeAllRanges(),sel.addRange(t),o.focus();var i=sel.toString(),r=J(n.target).closest(".editorHeaderParent");setTimeout(function(){var t=rng.startContainer,a=t.parentNode,l=o[0],c=selectedEle(sel,l);if(!(0===i.length&&r.is("[purpose=blockcode]")&&detectTag(c,l,["OL","UL","LI"])||r.is("[purpose=embedImageIcon]")&&detectTag(c,l,["BLOCKQUOTE","OL","UL","LI"])||r.is("[purpose=bullet],[purpose=number],[purpose=link],[purpose=blockcode],[purpose=embedImageIcon]")&&detectTag(c,l,["CODE"],["BLOCKQUOTE","OL","UL","LI"]))){if((r.is("[purpose=strong]")||r.is("[purpose=em]")||r.is("[purpose=underline]")||r.is("[purpose=strike]"))&&!r.attr("clicked")&&(r.toggleClass("active"),r.attr("clicked",!0)),0===i.length&&(r.is("[purpose=bullet]")||r.is("[purpose=number]")||r.is("[purpose=code]")||r.is("[purpose=blockcode]"))&&(r.toggleClass("active"),r.is("[purpose=number]")?e.find("[purpose=bullet]").removeClass("active"):r.is("[purpose=bullet]")&&e.find("[purpose=number]").removeClass("active"),disableEditorHeaderLiFromClass(e,r,0!==i.length)),r.is("[purpose=bullet]"))document.execCommand("insertUnorderedList",!1,null);else if(r.is("[purpose=number]"))document.execCommand("insertOrderedList",!1,null);else if(r.is("[purpose=strong]"))document.execCommand("bold",!1,null);else if(r.is("[purpose=em]"))document.execCommand("italic",!1,null);else if(r.is("[purpose=underline]"))document.execCommand("underline",!1,null);else if(r.is("[purpose=strike]"))document.execCommand("strikeThrough",!1,null);else if(r.is("[purpose=embedVideoIcon]"))(a.className.indexOf("mention")>-1||"DIV"===a.nodeName)&&getCommonTemplate(function(e){var n=e.find("[purpose=embedVdoCont]").clone();n.attr("editorId",o.attr("id")),n.attr("id","previewEmbedVdoCont"),n.find("[purpose=embedCode]").remove(),n.find("[purpose=embedFromLink]").show();var t=e.find("[purpose=uploadForVideoEmbed]").clone();n.find("[purpose=container]").append(t),J("body").append(n),buildFadeBGCont(n);var i=n.find("[purpose=uploadMedia]");n.find("[purpose=vdoDoneBtn]").find("button").attr("purpose","doneEmbedUpload"),n.find("[purpose=selector]").css({left:i.position().left,width:parseInt(i.width())}),videoUploadDragDrop(n,o.attr("id")),bindVideoEmbedClicks(n)});else if(r.is("[purpose=link]"))if("A"===t.tagName||"A"===a.tagName)document.execCommand("unlink",!1,null);else{e.find("[purpose=pasteLink]").show();var p=e.find("[purpose=linkContent]");p.focus().val(""),p.unbind("keyup").keyup(function(o){13===o.keyCode&&(e.find("[purpose=acceptLink]").click(),o.preventDefault())})}else if(r.is("[purpose=code]")){i=i.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>");var u=detectNode(c,l,"CODE"),m=document.createTextNode("​");if(u)if(i.length)loopEditorContentsForRemovingCodeTag();else{l.appendChild(m),sel.removeAllRanges();var g=document.createRange();g.setStart(m,1),g.collapse(!0),sel.addRange(g),o.focus()}else{0===i.length?(id++,document.execCommand("insertHTML",!1,"​<code id="+id+">​</code>​")):loopEditorContents(),sel.removeAllRanges();var g=document.createRange(),f=J("#"+id)[0].lastChild;g.setStart(f,f.length),g.collapse(!0),sel.addRange(g),o.focus()}}else if(r.is("[purpose=blockcode]")){i=i.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>");var u=detectNode(c,l,"BLOCKQUOTE"),m=document.createTextNode("​");if(u)if(i.length)loopEditorContentsForRemovingBlockquoteTag();else{l.appendChild(m),sel.removeAllRanges();var g=document.createRange();g.setStart(m,1),g.collapse(!0),sel.addRange(g),o.focus()}else{var h;if(0===i.length?(id++,document.execCommand("insertHTML",!1,"​<blockquote id="+id+">​</blockquote>​"),h=!0):h=loopBlockquoteEditorContents(l),h){sel.removeAllRanges();var g=document.createRange(),f=J("#"+id)[0].lastChild;g.setStart(f,f.length),g.collapse(!0),sel.addRange(g),o.focus()}}}else if(r.is("[purpose=acceptLink]")){var C=e.find("[purpose=linkContent]").val();if(C=C.replace(/&nbsp;/gm," ").replace(/\u200B/gm,""),C=J.trim(C),C.length&&!/^https?:+.?/i.test(C)&&(C="http://"+C),i=J.trim(i),0===i.length){if(detectTag(c,l,["A"])&&0===i.length&&C.length&&/^https?:\/\/+./i.test(C)){var u="A"===t.tagName?t:a;return l.removeChild(u),i=u.innerHTML,i=i.replace(/( |&nbsp;)+?/g," ").replace(/(\n|\n\r)/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;"),document.execCommand("insertHTML",!1,"​<a href='"+C+"' onclick='return false;'>"+i+"</a>​"),void e.find("[purpose=pasteLink]").hide()}i=C}if(C.length&&/^https?:\/\/+./i.test(C)){e.find("[purpose=pasteLink]").hide();var p=e.find("[purpose=linkContent]");i=i.replace(/( |&nbsp;)+?/g," ").replace(/(\n|\n\r)/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");try{document.execCommand("insertHTML",!1,"​<a href='"+C+"' onclick='return false;'>"+i+"</a>​")}catch(e){document.execCommand("createLink",!1,C);var m=document.createTextNode("​");l.appendChild(m)}var v=d.find("[purpose='addStreamBtn']"),b=v.attr("streamtype"),k=o.attr("headerid").indexOf("newedit")>-1;b&&"announcement"!==b&&"poll"!==b&&"question"!==b&&extractLink(o,n,!0,d,k)}else e.find("[purpose=linkContent]").focus()}else if(r.is("[purpose=linkContent]"))e.find("[purpose=linkContent]").focus();else if(r.is("[purpose=closeLink]")){e.find("[purpose=pasteLink]").hide();var p=e.find("[purpose=linkContent]");p.val(""),p.removeAttr("isVdo")}else if(r.is("[purpose=changeLink]")){var E=e.find("[purpose=changeLinkPopup]");E.hide(),e.show(),e.find("[purpose=changeLinkPopup]").removeAttr("isClicked");var T=a.href;e.find("[purpose=pasteLink]").show(),e.find("[purpose=linkContent]").val(T).focus(),e.find("[purpose=linkContent]").unbind("keyup").keyup(function(o){13===o.keyCode&&(e.find("[purpose=acceptLink]").click(),o.preventDefault())})}else if(r.is("[purpose=removeLink]")){var u="A"===t.tagName?t:a;J(u).replaceWith(u.innerHTML),!isFixedHeaderToolbar&&s&&e.hide(),e.find("[purpose=changeLinkPopup]").removeAttr("isClicked").hide()}else if(r.is("[purpose=closeLinkPopup]"))e.find("[purpose=changeLinkPopup]").removeAttr("isClicked").hide(),!isFixedHeaderToolbar&&s&&e.hide();else if(r.is("[purpose=goToLink]"))e.find("[purpose=changeLinkPopup]").attr("isClicked",!0);else if(r.is("[purpose=markdown]")){var N=e.find("[purpose=markdownHelp]");if(N.toggle(),N.is(":visible")){var L=r.closest(1===r.closest("#mainContainer").length?"#mainContainer":"#scrollableArea"),H=r.offset().top,w=N.height(),I=L.height()-H;H>I&&0>I-w?(N.css({top:-Math.abs(w+40-30)}),N.removeClass("topArrowRight").addClass("bottomArrowRight")):(N.css({top:30}),N.removeClass("bottomArrowRight").addClass("topArrowRight"))}}0!==i.length&&(c=selectedEle(sel,l),selectToolbar(e,c,l),disableEditorHeaderLi(l,c,e,!0))}},100)}})}function selectedEle(e,o){var n=rng.startContainer;return n===o?o.firstChild:n}function detectTag(e,o,n,t){return e?e.tagName?!(n.indexOf(e.tagName)>-1)||t&&e.parentNode&&-1!==t.indexOf(e.parentNode.tagName)?o===e?!1:detectTag(e.parentNode,o,n,t):!0:detectTag(e.parentNode,o,n,t):void 0}function detectNode(e,o,n){return e?e.tagName?n===e.tagName?e:o===e?void 0:detectNode(e.parentNode,o,n):detectNode(e.parentNode,o,n):void 0}function addEmbedLinkCont(e,o){getCommonTemplate(function(n){var t=J.trim(e.val());if(t){var i=n.find("[purpose=embedLinkPreview]").clone();i.find("[purpose=linkCont]").text(t),e.before(i),e.val("").focus(),o.find("[purpose=linksCont]").animate({scrollTop:e.position().top+o.find("[purpose=linksCont]").scrollTop()},100)}J("#newBlogPopupCont")[0]&&J("body").find("[purpose='removeEmbedLink']").unbind("click").click(function(){J(this).closest("[purpose=embedLinkPreview]").remove()})})}function bindEmbedLinks(e){var o=e.find("[purpose=embedLinkEditor]");o.unbind("paste").bind("paste",function(){setTimeout(function(){addEmbedLinkCont(o,e)},0)}),o.unbind("blur").bind("blur",function(){addEmbedLinkCont(o,e)}),o.unbind("keydown").keydown(function(n){var t=n.keyCode;(n.metaKey&&86===t||32===t||9===t||13===t)&&setTimeout(function(){addEmbedLinkCont(o,e)},0)})}function bindVideoEmbedClicks(e){e.unbind("click",processEmbedLinksClick).bind("click",processEmbedLinksClick)}function processEmbedLinksClick(e){var o=J(e.target),n=J(e.currentTarget);o.is("[purpose=closeCont]")?removePopupWithAnimate(n,"180px","fast"):o.is("[purpose=updateLinks]")?(n.find("[purpose=linkCont]").each(function(e,o){getEmbedVideoInfo(J(o).html(),J("#"+n.attr("editorId")),e)}),n.find("[purpose=closeCont]").trigger("click")):o.is("[purpose=doneEmbedUpload]")?(doneVideoEmbedUpload(J("#"+n.attr("editorId"))),n.find("[purpose=closeCont]").trigger("click")):o.is("[purpose=removeEmbedLink]")?o.closest("[purpose=embedLinkPreview]").remove():o.is("[purpose=loadInlineVideo]")?getCommonTemplate(function(e){var o=J("body");o.find("[purpose=embedVideoInline]").remove();var t=e.find("[purpose=inlineVideo]").clone();t.attr("id","embedVideoInline").attr("purpose","embedVideoInline").hide(),o.append(t),t.unbind("change").bind("change",function(){uploadEmbededVideo(J(this)[0].files,n.attr("editorId")),t.val("")}),t.click()}):o.is("[purpose=uploadMedia]")?(n.find("[purpose=selector]").css({left:o.position().left,width:parseInt(o.width())}),getCommonTemplate(function(e){var o=e.find("[purpose=uploadForVideoEmbed]").clone();n.find("[purpose=container]").html(o),n.find("[purpose=vdoDoneBtn]").find("button").attr("purpose","doneEmbedUpload"),videoUploadDragDrop(n,n.attr("editorId"))})):o.is("[purpose=embedFromLink]")&&(n.find("[purpose=selector]").css({left:o.position().left,width:parseInt(o.width())}),getCommonTemplate(function(e){var o=e.find("[purpose=embedLinkCont]").clone();n.find("[purpose=container]").html(o),n.find("[purpose=embedLinkEditor]").focus(),n.find("[purpose=vdoDoneBtn]").find("button").attr("purpose","updateLinks"),bindEmbedLinks(n)}))}function streamEmbedImage(e,o,n,t,i,r,d){if(!checkForImageFile(e))return!1;var s=new FormData;s.append("previewFile",e),s.append(ZPulse.csrfParamName,getCsrfToken()),s.append("scopeID",scopeID),s.append("isMultipleFileUpload","true");var a=d?"/connect/storePastedTempFile.do":"/connect/storeTempFile.do";return doAjaxFileUpload(a,s,function(e){var d=J("#"+t);if("success"===e.result){r||(o.setEnd(o.endContainer,o.endOffset),o.setStart(o.startContainer,o.startOffset),n.removeAllRanges(),n.addRange(o));var s=e.attachmentId;if(-1!=s&&(d.length||r)){d.remove();var a="/connect/viewTempFile.do?scopeID="+scopeID+"&fileId="+s+(window.isClientPortal?"&isClientPortal=true":"");r?widgetPostEditor.insertContent("<img src='"+a+"' alt='"+e.fileName+"'/>"):(document.execCommand("insertHTML",!1,"​<p data-value='img' class='embededImg'><img data-value='img' src='"+a+"' fileId='"+s+"' alt='"+e.fileName+"'/></p>​"),document.execCommand("enableObjectResizing",!1,"false"),J("[fileId='"+s+"']").on("load",function(){scrollPositionToFocus(i)}))}else-1==s&&showMessageStrip(getI18NVal("editor.unabletoaddfile"),"failureMsg")}else showMessageStrip(e.reason?e.reason:getI18NVal("connect.common.UnableToAttach"),"failureMsg");d.remove()}),!0}function checkForImageFile(e){var o=parseInt(e.size)/1024,n=e.name;return 0!==e.type.indexOf("image")?(showMessagePopup("errorMessage",getI18NVal("connect.common.notAnImage")),!1):0>=o?!1:o>10240?(e=0===e.type.indexOf("image")?null:e,showMessagePopup("errorMessage",getI18NVal("connect.common.maxFileSize")),!1):n.length>1e3?(showMessagePopup("errorMessage",getI18NVal("connect.common.fileNameMaxLength")),!1):!0}function pastedEmbedImage(e,o,n,t,i){var r={};return r.scopeID=scopeID,r.fileUrl=e,doPostAjaxCall("/storeTempFileFromUrl.do",r,function(e){var r=J("#"+t);if("success"===e.result){o.setEnd(o.endContainer,o.endOffset),o.setStart(o.startContainer,o.startOffset),n.removeAllRanges(),n.addRange(o);var d=e.attachmentId;if(-1!=d&&r.length){r.remove();var s="/connect/viewTempFile.do?scopeID="+scopeID+"&fileId="+d+(window.isClientPortal?"&isClientPortal=true":"");document.execCommand("insertHTML",!1,"​<p data-value='img' class='embededImg'><img data-value='img' src='"+s+"' fileId='"+d+"' alt='"+e.fileName+"'/></p>​"),document.execCommand("enableObjectResizing",!1,"false"),J("[fileId='"+d+"']").on("load",function(){scrollPositionToFocus(i)})}else-1==d&&showMessageStrip(getI18NVal("editor.unabletoaddfile"),"failureMsg")}else"failure"===e.result&&("maxFileSize"===e.reason?showMessageStrip(getI18NVal("connect.common.maxFileSize"),"failureMsg"):showMessageStrip(getI18NVal("connect.common.error"),"failureMsg"));r.remove()}),!0}function scrollPositionToFocus(e){if(sel||(sel=document.selection?document.selection:document.getSelection(),rng=sel.getRangeAt(0)),sel.type&&"None"!==sel.type){var o=rng.getClientRects()[0];if(o){var n=e.style.top+e.style.height-o.top-10-(J(e).closest("#flyoutViewer").length&&wmstoolbarHeight?wmstoolbarHeight:0);0>n&&e.animate({scrollTop:e.scrollTop+Math.abs(n)},5)}}}function setEditorMaxHeight(e,o,n){var t=e.style.maxHeight;if("none"===t||o){var i=e.closest(e.closest("#flyoutViewer").length?"#scrollableArea":"#mainContainer");i=i.length?i:e.closest("#quickComposeCont");var r=e.closest(e.closest("[purpose='composeCont']").length?"[purpose='composeCont']":"[purpose='cmtEditor']");if(r.hasClass("composeActive")){var d=r.closest("[purpose='editorHeader']"),s=!d.attr("isWidgetEditorHeader");if(s){var a=i.height()-(i.is("#scrollableArea")?0:120+wmstoolbarHeight);a=i.is("#quickComposeCont")?a-60:a;var l=r.find("[purpose='statusTitle']");a=l.is(":visible")?a-l.height():a,a=isFixedHeaderToolbar?a-(d?d.height()-4:21):a,a=r.find("[purpose='keepitprivatemessage']").length?a-r.find("[purpose='keepitprivatemessage']").height():a,a=r.find("[purpose='previewUploadCont']").length?a-r.find("[purpose='previewUploadCont']").height():a,a=r.find("[purpose='linkPreview']").length?a-r.find("[purpose='linkPreview']").height():a,a=r.find("[purpose='clientSharedMsg']").length?a-r.find("[purpose='clientSharedMsg']").height():a,e.css({"overflow-y":"auto","max-height":a}),n&&(scrollIfEnd(i,e),scrollPositionToFocus(e))}}}}function loopEditorContents(){var e=rng.startContainer,o=rng.endContainer;document.execCommand("selectAll"),codeContainer=document.createElement("div"),codeContainer.appendChild(window.getSelection().getRangeAt(0).cloneContents()),3===o.nodeType&&0===o.nodeValue.replace(/\u200B/gm,"").length&&(o=o.previousSibling);var n=loopForApplyingCode(codeContainer.childNodes,e,!1,o,rng.endOffset,rng.startOffset);if(n||!n){var t=codeContainer.innerHTML;t=t.replace(/<\/code>(\u200B|&#8203;)?<code (.+?)>/gi,""),document.execCommand("insertHTML",!1,t)}}function loopForApplyingCode(e,o,n,t,i,r){for(var d=0;d<e.length;d++)if(e[d].childNodes.length&&"CODE"!==e[d].nodeName){if(n=loopForApplyingCode(e[d].childNodes,o,n,t,i,r),"false"===n)return n}else{var s=e[d];if(o.isEqualNode(s)||n===!0&&"BR"!==s.nodeName&&"CODE"!==s.nodeName&&"IMG"!==s.nodeName){var a=s.innerHTML,l=a?a:s.nodeValue;l.replace(/\u200B/gm,"").length>0&&(id++,l=a?n===!1?t.isEqualNode(o)?[l.slice(0,r),"​<code id="+id+">",l.slice(r,i),"</code>​",l.slice(i)].join(""):[l.slice(0,r),"​<code id="+id+">",l.slice(r),"</code>​"].join(""):t.isEqualNode(s)?["​<code id="+id+">",l.slice(0,i),"</code>​",l.slice(i)].join(""):"​<code id="+id+">"+l+"</code>​":n===!1?t.isEqualNode(o)?[escapeHtmlTags(l.slice(0,r)),"​<code id="+id+">",escapeHtmlTags(l.slice(r,i)),"</code>​",escapeHtmlTags(l.slice(i))].join(""):[escapeHtmlTags(l.slice(0,r)),"​<code id="+id+">",escapeHtmlTags(l.slice(r)),"</code>​"].join(""):t.isEqualNode(s)?["​<code id="+id+">",escapeHtmlTags(l.slice(0,i)),"</code>​",escapeHtmlTags(l.slice(i))].join(""):"​<code id="+id+">"+escapeHtmlTags(l)+"</code>​",d++,n=t.isEqualNode(s)?"false":!0,J(s).replaceWith(l))}if(t.isEqualNode(s)&&n)return"false"}return n}function loopEditorContentsForRemovingCodeTag(){var e=rng.startContainer,o=rng.endContainer;document.execCommand("selectAll"),codeContainer=document.createElement("div"),codeContainer.appendChild(window.getSelection().getRangeAt(0).cloneContents()),3===o.nodeType&&0===o.nodeValue.replace(/\u200B/gm,"").length&&(o=o.previousSibling);var n=loopForRemovingCode(codeContainer.childNodes,e,!1,o,codeContainer);if(n||!n){var t=codeContainer.innerHTML;document.execCommand("insertHTML",!1,t)}}function loopForRemovingCode(e,o,n,t,i){for(var r=0;r<e.length;r++)if(e[r].childNodes.length){if(n=loopForRemovingCode(e[r].childNodes,o,n,t,i),"false"===n)return n}else{var d=e[r];if(o.isEqualNode(d)||n===!0&&"BR"!==d.nodeName&&"CODE"!==d.nodeName&&"IMG"!==d.nodeName){var s=d.innerHTML?d.innerHTML:d.nodeValue;if(s.replace(/\u200B/gm,"").length>0){var a=detectNode(d,i,"CODE");n=t.isEqualNode(d)?"false":!0,a&&(s=a.innerHTML,J(a).replaceWith(s))}}if(t.isEqualNode(d)&&n)return"false"}return n}function loopBlockquoteEditorContents(e){var o=rng.startContainer,n=rng.endContainer;if(((J(rng.commonAncestorContainer).is("[contenteditable=true]")||"DIV"===rng.commonAncestorContainer.nodeName||"P"===rng.commonAncestorContainer.nodeName)&&!detectNode(rng.endContainer,e,"LI")||3===rng.commonAncestorContainer.nodeType&&J(rng.commonAncestorContainer.parentElement).is("[contenteditable=true]"))&&(codeContainer=document.createElement("div"),codeContainer.appendChild(window.getSelection().getRangeAt(0).cloneContents()),-1===codeContainer.innerHTML.indexOf('<img data-value="img"')&&(-1===codeContainer.innerHTML.indexOf("<blockquote")||loopForRemovingNestedBlockquotes(codeContainer.childNodes,codeContainer))))return id++,document.execCommand("insertHTML",!1,"​<blockquote id="+id+">"+codeContainer.innerHTML+"</blockquote>​"),!0;document.execCommand("selectAll"),codeContainer=document.createElement("div"),codeContainer.appendChild(window.getSelection().getRangeAt(0).cloneContents()),3===n.nodeType&&0===n.nodeValue.replace(/\u200B/gm,"").length&&(n=n.previousSibling);var t=loopForApplyingBlockquote(codeContainer.childNodes,o,!1,n,rng.endOffset,rng.startOffset,codeContainer);if(t||!t){var i=codeContainer.innerHTML;return i=i.replace(/<span.*?>(.+?)<\/span>/gi,function(e,o){return o}),i=i.replace(/<p>(.+?)<\/p>/gi,function(e,o){return o}),i=i.replace(/<\/blockquote>(\u200B|&#8203;)*?([<br>]*?)(\u200B|&#8203;)*?<blockquote .+?>/gi,function(e,o,n){return n}),i=i.replace(/(.+?)(\u200B|&#8203;)+?(<blockquote .+?>)/gi,function(e,o,n,t){return o+t}),document.execCommand("insertHTML",!1,i),!1}}function loopForApplyingBlockquote(e,o,n,t,i,r,d){for(var s=0;s<e.length;s++){var a=e[s];if(a.childNodes.length&&"BLOCKQUOTE"!==a.nodeName&&"OL"!==a.nodeName&&"UL"!==a.nodeName){if(n=loopForApplyingBlockquote(a.childNodes,o,n,t,i,r,d),"false"===n)return n}else{if(o.isEqualNode(a)||!n&&o.parentElement.parentElement.isEqualNode(a)||n===!0&&"BR"!==a.nodeName&&"BLOCKQUOTE"!==a.nodeName&&"IMG"!==a.nodeName){var l=a.innerHTML,c="UL"===a.nodeName||"OL"===a.nodeName?a.outerHTML:a.innerHTML?a.innerHTML:a.nodeValue;c.replace(/\u200B/gm,"").length>0&&(id++,c=l?n===!1?o.parentElement.parentElement.isEqualNode(a)?"​<blockquote id="+id+">"+c+"</blockquote>​":t.isEqualNode(o)?[c.slice(0,r),"​<blockquote id="+id+">",c.slice(r,i),"</blockquote>​",c.slice(i)].join(""):[c.slice(0,r),"​<blockquote id="+id+">",c.slice(r),"</blockquote>​"].join(""):t.isEqualNode(a)&&!t.parentElement.parentElement.isEqualNode(a)?["​<blockquote id="+id+">",c.slice(0,i),"</blockquote>​",c.slice(i)].join(""):"​<blockquote id="+id+">"+c+"</blockquote>​":n===!1?o.parentElement.parentElement.isEqualNode(a)?"​<blockquote id="+id+">"+escapeHtmlTags(c)+"</blockquote>​":t.isEqualNode(o)?[escapeHtmlTags(c.slice(0,r)),"​<blockquote id="+id+">",escapeHtmlTags(c.slice(r,i)),"</blockquote>​",escapeHtmlTags(c.slice(i))].join(""):[escapeHtmlTags(c.slice(0,r)),"​<blockquote id="+id+">",escapeHtmlTags(c.slice(r)),"</blockquote>​"].join(""):t.isEqualNode(a)&&!t.parentElement.parentElement.isEqualNode(a)?["​<blockquote id="+id+">",escapeHtmlTags(c.slice(0,i)),"</blockquote>​",escapeHtmlTags(c.slice(i))].join(""):"​<blockquote id="+id+">"+escapeHtmlTags(c)+"</blockquote>​",s++,n=t.isEqualNode(a)||t.parentElement.isEqualNode(a)||t.parentElement.parentElement.isEqualNode(a)?"false":!0,J(a).replaceWith(c))}if((t.isEqualNode(a)||t.parentElement.parentElement.isEqualNode(a)||"BLOCKQUOTE"===a.nodeName&&a.isEqualNode(detectNode(t,d,"BLOCKQUOTE")))&&n)return"false"}}return n}function loopEditorContentsForRemovingBlockquoteTag(){var e=rng.startContainer,o=rng.endContainer;document.execCommand("selectAll"),codeContainer=document.createElement("div"),codeContainer.appendChild(window.getSelection().getRangeAt(0).cloneContents()),3===o.nodeType&&0===o.nodeValue.replace(/\u200B/gm,"").length&&(o=o.previousSibling);var n=loopForRemovingBlockquote(codeContainer.childNodes,e,!1,o,codeContainer);if(n||!n){var t=codeContainer.innerHTML;document.execCommand("insertHTML",!1,t)}}function loopForRemovingBlockquote(e,o,n,t,i){for(var r=0;r<e.length;r++)if(e[r].childNodes.length){if(n=loopForRemovingBlockquote(e[r].childNodes,o,n,t,i),"false"===n)return n}else{var d=e[r];if(o.isEqualNode(d)||n===!0&&"BR"!==d.nodeName&&"IMG"!==d.nodeName){var s=d.innerHTML?d.innerHTML:d.nodeValue;if(s.replace(/\u200B/gm,"").length>0){var a=detectNode(d,i,"BLOCKQUOTE");if(n=t.isEqualNode(d)?"false":!0,a){var s=a.innerHTML;J(a).replaceWith(s)}}}if(t.isEqualNode(d)&&n)return"false"}return n}function loopForRemovingNestedBlockquotes(e,o){for(var n=0;n<e.length;n++)if(e[n].childNodes.length&&"BLOCKQUOTE"!==e[n].nodeName)loopForRemovingNestedBlockquotes(e[n].childNodes,o);else{var t=e[n];if("BR"!==t.nodeName&&"IMG"!==t.nodeName){var i=t.innerHTML?t.innerHTML:t.nodeValue;if(i.replace(/\u200B/gm,"").length>0){var r=detectNode(t,o,"BLOCKQUOTE");r&&(i=r.innerHTML,J(r).replaceWith(i))}}}return!0}function escapeHtmlTags(e){return e}var J=jQuery,rng,sel,isFixedHeaderToolbar=void 0,wmstoolbarHeight,id=0,tags={B:"strong",I:"em",U:"underline",STRIKE:"strike",BLOCKQUOTE:"blockcode",CODE:"code",A:"link",PRE:"code",UL:"bullet",OL:"number"},codeContainer;var J=jQuery,ConnectEditor={};ConnectEditor.config={},ConnectEditor.init=function(e,t,n,a,i){ConnectEditor.element=e,ConnectEditor.config.connectUrl=a?a:"//connect.zoho.com",ConnectEditor.config.contactUrl=n?n:"//contacts.zoho.com",t&&ConnectEditor.bindUserMention(e,t,i),e.unbind("paste").bind("paste",function(t){ConnectEditor.handlePasteInRichContent(t,e),setTimeout(function(){scrollPositionToFocus(e),scrollIfEnd(J("#mainContainer"),e)},100)}),e.is("[isTextEditor=true]")&&taskEditorKeyDownPreventFormatting(e)},ConnectEditor.handlePasteInRichContent=function(e,t){var n=(e.originalEvent||e).clipboardData,a=!1,i=n.items;if(!t.is("[isTextEditor=true]")&&i){var o;getCommonTemplate(function(e){for(o=0;o<i.length;o++){var r=i[o],l=r.type;if("file"===r.kind&&l.match(/image.*/)){a=!0;var c=r.getAsFile(),s=parseInt(c.size)/1024;if(0>=s)return!1;if(s>10240)return showMessagePopup("errorMessage",getI18NVal("connect.common.maxFileSize")),!1;var d,u=n?n.getData("text/plain"):"",p=document.getSelection();try{d=p.getRangeAt(0)}catch(e){d=document.createRange()}rng=d;var m=(new Date).getTime();if(/^https?:\/\/+./.test(u)){if(pastedEmbedImage(u,d,p,m,t)){var g=e.find("[purpose=threeDotsloading]").clone().attr("data-value","spinner");document.execCommand("insertHTML",!1,"​<p data-value='img' class='embededImg' id='"+m+"'>"+J(g)[0].outerHTML+"</p>​")}}else{var f=u.split(/\n|\r\n|\r/)[0];f=f.length<1e3?f:"";var v=new File([c],f,{type:l,lastModified:m});if(streamEmbedImage(v,d,p,m,t,!1,!0)){var g=e.find("[purpose=threeDotsloading]").clone().attr("data-value","spinner");document.execCommand("insertHTML",!1,"​<p data-value='img' class='embededImg' id='"+m+"'>"+J(g)[0].outerHTML+"</p>​")}}}}})}if(a)return e.preventDefault(),!1;if(window.clipboardData)return e.preventDefault(),document.selection.createRange().pasteHTML(window.clipboardData.getData("Text")),!0;if(document.queryCommandEnabled("insertHTML")&&n){e.preventDefault();var r=n.getData("text/html"),l=window.getSelection();if(r&&!t.is("[isTextEditor=true]")){if(r=r.replace(/<style[^>]*>(.|\s)*?<\/style>/gi,""),r=r.replace(/<head[^>]*>(.|\s)*?<\/head>/gi,""),r=r.replace(/(<div[^>]*?>.*?)(<br>)(<\/div>)/gi,"$1$3"),r=r.replace(/(<p[^>]*?>.*?)(<br>)(<\/p>)/gi,"$1$3"),r=getPastedContent(J("<div />").html(r)[0]),r=r.replace(/(<a[^>]+?><\/a>)/g,""),r=r.replace(/(<a[^>]+?>.+?<\/a>)/g,function(e){var t=J(e);e=t[0].outerHTML.replace(/(<(?!(\/?(a))).*?>)/g,"");var n=t.attr("href");if(n){var a=baseURL+niceurlPrefix;if(n.indexOf(a+"/profile/")>-1){var i=n.split("/"),o=i[i.length-1],r=userListWithId[o];if(r&&t.html()==="@"+r.fullname)return'<span type="'+r.type+'" spellcheck="false" contenteditable="false" data-value="'+o+'" class="highlight">@'+r.fullname+"</span>"}else if(n.indexOf(a+"/group/")>-1){var l,i=n.split("/"),c=i[i.length-1];if($.each(groupsMeta,function(e,t){return t.url===c?void(l=t):void 0}),l&&t.html()==="@"+l.name)return'<span type="G" spellcheck="false" contenteditable="false" data-value="'+l.id+'" class="highlight">@'+l.name+"</span>"}}return e}),r=r.replace(/(<a[^>]+?>.+?<\/a>)/g,function(e){var t=J(e);return e=t[0].outerHTML.replace(/(<(?!(\/?(a))).*?>)/g,""),t.attr("href")&&0===t.attr("href").split("://")[0].indexOf("http")?e:t.html()}),r=r.replace(/(\r?\n|\r)/gm,""),l.rangeCount>0){var c=detectNode(l.focusNode,t,"BLOCKQUOTE");if(c){document.execCommand("insertHTML",!1,"</blockquote><blockquote>​"+r+"​"),document.execCommand("selectAll"),codeContainer=document.createElement("div"),codeContainer.appendChild(window.getSelection().getRangeAt(0).cloneContents());var s=codeContainer.innerHTML;s=s.replace(/<\/blockquote><blockquote.*?>/gi,""),s=s.replace(/<blockquote.*?>(.*?)<blockquote.*?>(.*?)<\/blockquote>(.*?)<\/blockquote>/gi,function(e,t,n,a){return"<blockquote>​"+t+n+a+"</blockquote>​"}),document.execCommand("insertHTML",!1,s)}else document.execCommand("insertHTML",!1,r)}return!0}if(r=n.getData("text/plain")){if(l.rangeCount>0){r=r.replace(/</gm,"&lt;").replace(/>/g,"&gt;").replace(/\u200B/gm,"").replace(/(\n|\r\n)/gm,"<br/>");var c=detectNode(l.focusNode,t,"BLOCKQUOTE");if(c){document.execCommand("insertHTML",!1,"</blockquote><blockquote>​"+r+"​"),document.execCommand("selectAll"),codeContainer=document.createElement("div"),codeContainer.appendChild(window.getSelection().getRangeAt(0).cloneContents());var s=codeContainer.innerHTML;s=s.replace(/<\/blockquote><blockquote.*?>/gi,""),s=s.replace(/<blockquote.*?>(.*?)<blockquote.*?>(.*?)<\/blockquote>(.*?)<\/blockquote>/gi,function(e,t,n,a){return"<blockquote>​"+t+n+a+"</blockquote>​"}),document.execCommand("insertHTML",!1,s)}else document.execCommand("insertHTML",!1,r)}return!0}}return!1},ConnectEditor.bindUserMention=function(e,t,n){if(!n||!n.is("[stype=BLOG]")){var a,i=t;if(n&&n.length){if(a=n.data("participantsMentionData"),!a){var o=n.data("mentionParticipantIds");if(o&&userListWithId){var r="",l="";$.each(o,function(e,t){var n=userListWithId[t];n&&(r=r+l+JSON.stringify(n),l=",")}),a=r,n.data("participantsMentionData",r)}}}else a=e.data("participantsMentionData");try{if(a){var c=JSON.stringify(i);c=c.substring(1),c="["+a+","+c,i=$.parseJSON(c)}}catch(e){reportScriptError("problem in participantsMentionData ",e)}i=i?i:t,e.rich_textarea({triggers:[{trigger:"@",callback:function(e,t){var n=ConnectEditor.mentionsFilter(i,e);$.each(n,function(e,t){t.value={value:t.id,content:"<span type="+(t.type?t.type:"C")+' spellcheck="false" contenteditable="false">@'+t.name+"</span> "}}),t(n)}}]})}},ConnectEditor.mentionsFilter=function(e,t,n,a,i,o,r){var l=a?a:[],c=i?i:10;t=$.ui.autocomplete.escapeRegex(t);var s=new RegExp("^"+t+"$","i"),d=n?n:[];$.each(e,function(e,t){return o&&"OG"===t.type?void 0:d.length===c?!1:"P"===t.type?!0:void((!r||"CL"!==t.type&&"RC"!==t.type)&&-1===l.indexOf(t.id)&&(s.test(t.name)||s.test(t.email)||s.test(t.emailId)||s.test(t.fullname)||s.test(t.value))&&(l.push(t.id),d.push(t)))});var u=new RegExp("^"+t,"i");$.each(e,function(e,t){return o&&"OG"===t.type?void 0:d.length===c?!1:"P"===t.type?!0:!r||"CL"!==t.type&&"RC"!==t.type?void(-1===l.indexOf(t.id)&&(u.test(t.name)||u.test(t.email)||u.test(t.emailId)||u.test(t.fullname)||u.test(t.value))&&(l.push(t.id),d.push(t))):!1});var p=new RegExp(t,"i");return $.each(e,function(e,t){return o&&"OG"===t.type?void 0:d.length===c?!1:"P"===t.type?!0:!r||"CL"!==t.type&&"RC"!==t.type?void(-1===l.indexOf(t.id)&&(p.test(t.name)||p.test(t.email)||p.test(t.emailId)||p.test(t.fullname)||p.test(t.value))&&(l.push(t.id),d.push(t))):!1}),d},ConnectEditor.mentionRenderItem=function(e){var t=e.data.name,n="",a="";if("C"===e.data.type||"CL"===e.data.type||"RC"===e.data.type)n=e.photoURL,a='<img class="sI" src="'+n+'">';else if("G"===e.data.type)if("0"!==e.logoType&&"1"!==e.logoType||!e.logoUrl){var i=colouredBoxImage(inputTextTransformer(t));if(i){var o=i.split(",");a='<span class="titleFirstLetter avatar avatarSmall '+o[1]+'"><span>'+o[0]+"</span></span>"}}else a='<img class="avatar avatarSmall" src="'+e.logoUrl+'">';else if("OG"===e.type){var r=e.email;r&&(t=e.name+" ("+r+")"),n=ConnectEditor.config.connectUrl+"/images/imgGroupDef.png",a='<img class="avatar avatarSmall" src="'+n+'">'}t=J("<div/>").text(t).text();var l="spCmtMention",c=e.data.name;return J('<a class="'+l+'">'+a+"<span>"+c+"</span></a>")},ConnectEditor.getText=function(){var e=ConnectEditor.actualTextContent(ConnectEditor.element[0].childNodes);return e=e.replace(/\u200B/gm,"").replace(/&nbsp;/g," "),$.trim(e)},ConnectEditor.isRichTextNotEmpty=function(e){for(var t=e.childNodes,n=t.length,a=0;n>a;a++){var i=t[a],o="",r=i.tagName,l=i.textContent.replace(/\u200B/gm,"").replace(/&nbsp;/g," ");if(8!==i.nodeType){if(3===i.nodeType||4===i.nodeType)o=l;else if("smilie"===i.getAttribute("data-value"))o+=i.getAttribute("match");else if("IMG"===r)o+="img";else if("BR"===r||"P"===r)"P"===r&&"IMG"===i.firstElementChild.tagName?o=i.firstElementChild.src:o+="\n";else if("OL"===r||"UL"===r||"BLOCKQUOTE"===r)o+=r;else if("DIV"===r){var c=i.childNodes;o=1===c.length&&"BR"===c[0].tagName?"\n":"\n"+actualRichTextContent(c)}else o=l;if($.trim(o.replace(/\u200B/gm,"")).length)return!0}}return!1},ConnectEditor.isMentionExists=function(e){var t=e.find("[type=C]");return t.length&&t.attr("data-value")?!0:(t=e.find("[type=OG]"),t.length&&t.attr("data-value")?!0:(t=e.find("[type=G]"),t.length&&t.attr("data-value")?!0:!1))},ConnectEditor.actualTextContent=function(e){for(var t=e.length,n="",a=0;t>a;a++){var i=e[a];if(8!==i.nodeType)if(3===i.nodeType||4===i.nodeType)n+=i.textContent;else if(i.getAttribute("type")&&!isNaN(i.getAttribute("data-value")&&i.textContent.length)){var o=i.getAttribute("type");if("G"===o||"C"===o||"OG"===o){var r=("G"===o?"group":"OG"===o?"orggroup":"user")+":mention";n+="<"+r+">"+i.getAttribute("data-value")+":"+i.textContent+"</"+r+">"}}else if("BR"===i.tagName)n+="\n";else if("P"===i.tagName)n+="\n"+ConnectEditor.actualTextContent(i.childNodes);else if("DIV"===i.tagName){var l=i.childNodes;n+=1===l.length&&"BR"===l[0].tagName?"\n":"\n"+ConnectEditor.actualTextContent(l)}else n+=i.textContent}return n};!function(e){var t=document,n=document,i=t.selection?t.selection:t.getSelection();e.widget("ui.rich_textarea",{options:{triggers:[],regexes:[],sheet:[]},_create:function(){var n=this;this.current_trigger=!1,this.currentRange=!1,this.selectionEntered=!1,this.do_regex=!0,this.autocomplete_open=!1;var i=e(window.isNewUI?"#mainContainer":"body");this._on({keyup:function(e){this._onKeyUp(e)},keypress:function(e){this._onKeyPress(e)},keydown:function(e){this._onKeyDown(e)},mouseup:function(e){this._onMouseUp(e)},focus:function(e){this._onFocus(e)},paste:function(e){this._onPaste(e)}}),this.element.autocomplete({autoFocus:!0,html:"html",appendTo:i,open:function(){n.autocomplete_open=!0;var i=n.element,o=i.autocomplete("widget"),r=t.selection?t.selection:t.getSelection();rng=r.getRangeAt(0);var a,s=rng.getClientRects(),d=window.isNewUI?e("#mainContainer").scrollTop()-47:e(window).scrollTop();if(window.isNewUI){var l=o.height(),f=s[0].height+2,c=s[0].top+d;a=window.innerHeight<s[0].top+l?c-f-o.height():c+f}else a=s.length?s[0].top+d+s[0].height+2:null;o.css({width:i.parent().width(),top:a?a+"px":"-=3px",position:"absolute"}).addClass("full-ui-autocomplete fntSiz12")},close:function(){n.autocomplete_open=!1,n.do_regex=!0},source:function(e,t){if(!n.element.data("isGuest")){var i=n._checkForTrigger();i&&i&&i.word.length&&i.callback(i.word,t)}},focus:function(e){return e.preventDefault(),!1},select:function(e,t){n._insertSelection(n.current_trigger,t.item.value),e.preventDefault(),n.do_regex=!1}}),this.element.data("ui-autocomplete")._renderItem=function(t,n){return e("<li></li>").data("item.autocomplete",n).append(window.ConnectEditor?ConnectEditor.mentionRenderItem(n):mentionRenderItem(n)).appendTo(t)}},_onKeyDown:function(n){var o=null,r=null,a=n.which;if(this.autocomplete_open&&(a===e.ui.keyCode.UP||a===e.ui.keyCode.DOWN||a===e.ui.keyCode.ENTER))return n.preventDefault(),!0;if(i=t.getSelection(),i.rangeCount){var s=i.getRangeAt(0);if(!s.collapsed)return}switch(a){case 0:break;case e.ui.keyCode.BACKSPACE:var d=!1;(o=this._checkForAdjacentObject("left"))&&(this.deleteObject(o.dom_node),o.preventDefault&&n.preventDefault());break;case e.ui.keyCode.DELETE:var d=!1;if("stop"==(d=this._deleteZeroSpace()))return;(o=this._checkForAdjacentObject("right"))&&(this.deleteObject(o.dom_node),n.preventDefault());break;case e.ui.keyCode.LEFT:var l=this._getCaretPosition();if(o=this._isEmbeddedObject(l.dom_node)){this._setCaretPositionRelative(o.previousSibling,"end"),n.preventDefault();break}(r=this._moveCaret(l.dom_node,l.offset,"left"))&&(r.checkForObjects&&(o=this._checkForAdjacentObject("left"))&&(this._setCaretPositionRelative(o.dom_node.previousSibling,"end"),n.preventDefault()),r.preventDefault&&n.preventDefault());break;case e.ui.keyCode.RIGHT:var l=this._getCaretPosition();if(o=this._isEmbeddedObject(l.dom_node)){this._setCaretPositionRelative(o.nextSibling,"beginning");break}(r=this._moveCaret(l.dom_node,l.offset,"right"))&&(r.checkForObjects&&(o=this._checkForAdjacentObject("right"))&&this._setCaretPositionRelative(o.dom_node.nextSibling,"beginning"),r.preventDefault&&n.preventDefault());break;case e.ui.keyCode.ENTER:return this._handleEnter(n),!1}},_onKeyPress:function(n){var i=n.which;if(this.autocomplete_open&&(i===e.ui.keyCode.UP||i===e.ui.keyCode.DOWN||i===e.ui.keyCode.ENTER))return n.preventDefault(),!0;var o=t.getSelection(),r=o.getRangeAt(0),a=r.startContainer;i===e.ui.keyCode.ENTER&&("LI"===a.tagName||"OL"===a.tagName||"UL"===a.tagName||"LI"===a.parentNode.tagName||"UL"===a.parentNode.tagName||"OL"===a.parentNode.tagName)},_onKeyUp:function(n){var i=null,o=n.which;if(this.autocomplete_open&&(o===e.ui.keyCode.UP||o===e.ui.keyCode.DOWN||o===e.ui.keyCode.ENTER))return n.preventDefault(),!0;var r=t.getSelection(),a=r.getRangeAt(0),s=a.startContainer;if(o!==e.ui.keyCode.ENTER||"LI"!==s.tagName&&"OL"!==s.tagName&&"UL"!==s.tagName&&"LI"!==s.parentNode.tagName&&"UL"!==s.parentNode.tagName&&"OL"!==s.parentNode.tagName){if(!this._handleRangeSelection()){switch(this._saveRange(),o){case e.ui.keyCode.ENTER:if(this.element.autocomplete("close"),this.current_trigger=!1,this.selectionEntered){this.selectionEntered=!1;break}this._onEnterFixUp(n);break;case e.ui.keyCode.SPACE:case e.ui.keyCode.TAB:case e.ui.keyCode.HOME:case e.ui.keyCode.END:this.element.autocomplete("close"),this.current_trigger=!1;break;case e.ui.keyCode.LEFT:case e.ui.keyCode.RIGHT:case e.ui.keyCode.BACKSPACE:i=this._getCaretPosition();var d=this._clickedOnObject(i.dom_node);if(d)return void this._setCaretPositionRelative(d,"before");this._search()||(this.element.autocomplete("close"),this.current_trigger=!1);break;case e.ui.keyCode.UP:i=this._getCaretPosition();var d=this._clickedOnObject(i.dom_node);d&&this._setCaretPositionRelative(d,"before");break;case e.ui.keyCode.DOWN:i=this._getCaretPosition();var d=this._clickedOnObject(i.dom_node);d&&this._setCaretPositionRelative(d,"after");break;case e.ui.keyCode.ESCAPE:return!1}this._search()}}else{var l=s.previousElementSibling;if(l){var f=l.outerHTML;f=f.replace(/[<br>]+?<\/li>/,"</li>"),e(l).replaceWith(f)}}},_onMouseUp:function(t){if(this.element.autocomplete("close"),!e("#"+this.element.attr("id")).is(":focus"))return!0;if(this._handleRangeSelection()){var n=e(t.target);if(n.is("p[data-value]"))return void this._setCaretPositionRelative(n[0],"before")}this._saveRange();var o=this._clickedOnObject(t.target);if(o){this._setCaretPositionRelative(o,"before");var n=t.target,r=o.getAttribute("purpose");if("videoImgCont"===r){o.previousSibling&&3===o.previousSibling.nodeType||this._insertEmptyNode(o,"before"),o.nextSibling&&3===o.nextSibling.nodeType||this._insertEmptyNode(o,"after");var a=document.createRange();a.setStart(o.previousSibling,o.previousSibling.length),a.setEnd(o.nextSibling,0),i.removeAllRanges(),i.addRange(a),this._saveRange()}else if("IMG"===n.nodeName){var a=document.createRange(),s=e(o).closest("p")[0];s.previousSibling&&3===s.previousSibling.nodeType||this._insertEmptyNode(s,"before"),s.nextSibling&&3===s.nextSibling.nodeType||this._insertEmptyNode(s,"after"),a.setStart(s.previousSibling,s.previousSibling.length),a.setEnd(s.nextSibling,0),i.removeAllRanges(),i.addRange(a),this._saveRange()}t.preventDefault()}},_search:function(){var e=this._checkForTrigger();return e&&e.word?(this.element.autocomplete("search",e.word),!0):!1},_onFocus:function(e){return this.autocomplete_open?(e.preventDefault(),!1):void 0},_onPaste:function(e){if(this.options.sheet.handlePasteInRichContent(e,this.element))this._search();else{this._onPrePaste(e);var t=this;setTimeout(function(){t._onPostPaste(e)},75)}return!0},_onPrePaste:function(){e(this.element).find("*").each(function(){e(this).data("uid","1")})},_onPostPaste:function(t){this.element.find("*").each(function(){var t=e(this);t.data("uid")||3==t.get(0).nodeType||"BR"==t.get(0).nodeName||t.replaceWith(t.text())}),this._checkRegexes(t)},_onEnterFixUp:function(){var t=this._getCaretPosition();if(null==t.dom_node.previousSibling?this._checkSibling(t.dom_node.parentNode,"prev"):3!=t.dom_node.previousSibling.nodeType&&(this._insertEmptyNode(t.dom_node.previousSibling,"before"),this._insertEmptyNode(t.dom_node.previousSibling,"after")),0!=e(t.dom_node).filter("[_moz_dirty]").length)this._insertEmptyNode(t.dom_node,"before"),this._insertEmptyNode(t.dom_node,"after");else if(this._isEmbeddedObject(t.dom_node)){var n=this._insertEmptyNode(t.dom_node,"before");this._selectTextNode(n,0)}else if("DIV"==t.dom_node.nodeName||"SPAN"==t.dom_node.nodeName||"P"==t.dom_node.nodeName){var i=t.dom_node.childNodes;0==i.length?this._insertEmptyNode(t.dom_node,"child"):3!=i[0].nodeType&&(this._insertEmptyNode(i[0],"before"),this._insertEmptyNode(i[0],"after"))}},detectTag:function(e,t){if(!e)return!1;var n=e.tagName;return n&&"true"===e.getAttribute("contenteditable")?!1:!n||n&&-1===t.indexOf(n)?this.detectTag(e.parentNode,t):!0},_handleEnter:function(n){var i=t.getSelection(),o=i.getRangeAt(0),r=o.startContainer;if(this.detectTag(r,["LI","OL","UL"]))return void(r.nodeValue&&/^[\u200B]+$/.test(r.nodeValue)&&e(r).remove());if(n.preventDefault(),!o){var a=e("<br>"),s=e("#"+this.element.attr("id"));e(a).appendTo(s);var d=this._insertEmptyNode(a.get(0),"before",!0),l=this._insertEmptyNode(a.get(0),"after",!0);return o=rangy.createRange(),i=rangy.getSelection(),o.setStart(d,0),o.setEnd(l,0),o.collapse(!1),i.removeAllRanges(),i.addRange(o),i.refresh(),this.focus(),!1}i.addRange(o);var s=e("<br>"),f=s.get(0);o.insertNode(s.get(0)),o.setStartAfter(s.get(0)),o.setEndAfter(s.get(0)),o.collapse(!1),i.removeAllRanges(),i.addRange(o);var c=(this._insertEmptyNode(f,"before",!0),this._insertEmptyNode(f,"after",!0));return this._selectTextNode(c,1),!1},_handleRangeSelection:function(){var e=t.getSelection();try{var n=e.getRangeAt(0)}catch(e){return!1}var i=null,o=null;return n.collapsed?!1:(0!=(i=this._clickedOnObject(n.startContainer))&&n.setStartBefore(i),0!=(o=this._clickedOnObject(n.endContainer))&&n.setEndAfter(o),(0!=i||0!=o)&&(e.removeAllRanges(),e.addRange(n)),!0)},_saveRange:function(e){if("undefined"==typeof e)try{var e=i.getRangeAt(0)}catch(e){return!1}this.currentRange=e.cloneRange()},_checkForTrigger:function(){var e=this._getCaretPosition();if(!e||-1==e.offset)return!1;var t=this._isTrigger(e.dom_node,e.offset);return this.current_trigger=t,t},_checkRegexes:function(e){var t=this.options.regexes,n=t.length;if(!n)return!1;var i=null,o=this._getCaretPosition();if(-1==o.offset)return!1;if("keyup"==e.type){if(o.offset<3)return;o.offset--}if(i=this._getWord(o.dom_node,o.offset-1))for(var r=0;n>r;r++)i.word.match(t[r].regex)&&t[r].callback(i)},_isTrigger:function(e,t){var n=null;if(3===e.nodeType&&t>0){var i=e.parentNode.tagName;if("CODE"===i||"A"===i||"BLOCKQUOTE"===i)return;var o=e.nodeValue;if(!o)return null;var r=e.previousSibling,a=o.substr(0,t),s=e,d=-1,l=t,f=-1;if(r&&3===r.nodeType){var c=r.nodeValue;f=c.length,a=c+a}if(n=this._isTriggerCharInWord(a)){var u=a.substr(n.index+1),h=u.length;if(0===h)n=null;else{if(f>n.index){var g=a.length-f;g>0&&(d=n.index,s=r,l=g)}-1==d&&(d=t-h-1),n.startOffset=d,n.startNode=s,n.word=u,n.endNode=e,n.endOffset=l}}}return this.current_trigger=n,n},_getWordEnd:function(e){var t=200,n="",i=e.startNode,o=e.startOffset;for(e.word="";;){if(t--<=0)return!1;if(o>=i.nodeValue.length){if(null==i.nextSibling)return e.endNode=i,e.endOffset=o-1,e.word=n,e;if(3!=i.nextSibling.nodeType)return e.endNode=i,e.endOffset=o-1,e.word=n,e;if(i=i.nextSibling,o=0,0==i.nodeValue.length)continue}var r=i.nodeValue;if("​"!=r.charAt(o)){if(r.charAt(o).match(/\s+/))return e.endNode=i,e.endOffset=o-1,e.word=n,e;n+=r.charAt(o),o++}else o++}},_isTriggerCharInWord:function(e){var t=this.options.triggers,n=e.lastIndexOf("@");if(-1!==n){var i=e.substring(0,n),o=i.lastIndexOf("@");return-1!==o&&i.lastIndexOf(" ")>o?(t[0].index=n,t[0]):(t[0].index=-1!==o?o:n,t[0])}return!1},_isTriggerChar:function(e){var t=this.options.triggers;for(var n in t)if(e==t[n].trigger)return t[n];return!1},_getWord:function(e,t){for(var n=200,i={},o=!1;;){if(n--,0>=n)return!1;if(-1==t){if(null==e.previousSibling)break;if(3!=e.previousSibling.nodeType)break;e=e.previousSibling;var r=e.nodeValue;if(t=r.length-1,-1==t)continue}var r=e.nodeValue;if("​"!=r.charAt(t)){if(r.charAt(t).match(/\s+/))break;o=!0,t--}else t--}return i.startNode=e,i.startOffset=t+1,o?i=this._getWordEnd(i):!1},_checkForAdjacentObject:function(t){var n={},i=null;if(!(n=this._getCaretPosition()))return!1;if(i=n.dom_node,this._isEmbeddedObject(i))return{dom_node:i,container_spanned:!1,preventDefault:!0};if(0==(n=this._treeWalker(n.dom_node,n.offset,t)))return!1;if(0!=e(i).filter("[_moz_dirty]").length){if("left"!=t)return!1;if(0==(n=this._treeWalker(n.dom_node.previousSibling,n.offset,t)))return!1}if(3==n.dom_node.nodeType)if("left"==t&&0==n.offset){if(this._isEmbeddedObject(n.dom_node.previousSibling))return{dom_node:n.dom_node.previousSibling,container_spanned:!n.checkForObjects,preventDefault:n.preventDefault}}else if("right"==t&&n.offset==n.dom_node.nodeValue.length&&this._isEmbeddedObject(n.dom_node.nextSibling))return{dom_node:n.dom_node.nextSibling,container_spanned:!n.checkForObjects,preventDefault:n.preventDefault};if(!this._isEmbeddedObject(n.dom_node)||null!=e(n.dom_node).attr("data-value")){var o=!0,r=n.dom_node;if(null==e(r).attr("data-value"))return!1;for(var a=100;;){if(a--<=0)break;if(!r.nextSibling)break;if(3!=r.nextSibling.nodeType&&("UL"===r.nextSibling.nodeName||"OL"===r.nextSibling.nodeName)){o=!1;break}r=r.nextSibling}if(!o)return!1}return{dom_node:n.dom_node,container_spanned:!n.checkForObjects,preventDefault:n.preventDefault}},_clickedOnObject:function(t){for(;e(t).attr("id")!=this.element.attr("id");){var n=this._isEmbeddedObject(t);if(n)return n;if(!t.parentNode)return null;t=t.parentNode}return!1},deleteObject:function(n){var i=t.getSelection(),o=n.parentNode,r=this._getObjectRange(n);r.deleteContents(),r.collapse(!0),i.removeAllRanges(),i.addRange(r),e(o).attr("id")!=this.element.attr("id")&&0==o.childNodes.length&&(r.setStartBefore(o),r.setEndAfter(o),r.deleteContents(),r.collapse(!0),i.removeAllRanges(),i.addRange(r)),this._saveRange()},_moveCaret:function(t,n,i){var o={};if(0==(o=this._treeWalker(t,n,i)))return!1;if("object"==o.type)return"left"==i?this._setCaretPositionRelative(o.dom_node,"after"):this._setCaretPositionRelative(o.dom_node,"before"),o;if("container"==o.type){if("left"==i){var r=o.dom_node.previousSibling;return"DIV"==r.nodeName||"P"==r.nodeName?0==r.childNodes.length?!1:(this._setCaretPositionRelative(r,"end"),o.dom_node=r.childNodes[r.childNodes.length-1],o):3==r.nodeType?(o.dom_node=r,0==o.dom_node.nodeValue.length?!1:(this._setCaretPositionRelative(o.dom_node,"end"),o)):(o.dom_node=r,this._setCaretPositionRelative(o.dom_node,"before"),o)}if(null==o.dom_node.nextSibling)return this._setCaretPositionRelative(o.dom_node,"after"),o;if("DIV"==o.dom_node.nextSibling.nodeName||"P"==o.dom_node.nextSibling.nodeName){if(0==o.dom_node.nextSibling.childNodes.length)return!1;o.dom_node=o.dom_node.nextSibling.childNodes[0]}return this._setCaretPositionRelative(o.dom_node,"after"),o}if("child"==o.type)return 3==o.dom_node.nodeType?0==o.dom_node.nodeValue.length?(this._selectTextNode(o.dom_node,0),o):(this._selectTextNode(o.dom_node,0),o):o;if(3==o.dom_node.nodeType)return this._selectTextNode(o.dom_node,o.offset),o;if("BR"==o.dom_node.nodeName){if(0!=e(o.dom_node).filter("[_moz_dirty]").length)return"left"==i?(o.type="_moz_dirty",o.preventDefault=!0,this._setCaretPositionRelative(o.dom_node,"before"),o):(this._setCaretPositionRelative(o.dom_node,"after"),o);"left"==i?this._setCaretPositionRelative(o.dom_node,"before"):this._setCaretPositionRelative(o.dom_node,"after")}return o},_backspaceZeroSpace:function(o){var r=null,a={},s={},d={},l=null;a=this._getCaretPosition(),r=a.dom_node;var f=r.parentNode;if(r.tagName&&"LI"===r.tagName){var c=e(r);if(0===c.siblings().length)return this._insertEmptyNode(c.parent(),"before"),c.parent().remove(),"stop"}else if(f&&f.tagName&&"LI"===f.tagName&&(""===f.textContent.replace(/[\u200B]/gm,"")||"<br>"===f.textContent.replace(/[\u200B]/gm,""))){var c=e(f);if(0===c.siblings().length)return this._insertEmptyNode(c.parent(),"before"),c.parent().remove(),"stop"}else if(r.tagName&&"<br>"===r.innerHTML.replace(/[\u200B]/gm,"")||"BR"===r.tagName)return void e(r).remove();if(!(3!=r.nodeType||("DIV"!==f.tagName||e(f).hasClass("mention"))&&"SPAN"!==f.tagName&&"P"!==f.tagName||""!==f.innerHTML.replace(/[\u200B]/gm,"")&&"<br>"!==f.innerHTML.replace(/[\u200B]/gm,"")))return this._insertEmptyNode(e(f),"before"),void e(f).remove();if(3==r.nodeType&&!r.previousElementSibling&&""===r.textContent.replace(/[\u200B]/gm,"")&&e(f).hasClass("mention"))return o.preventDefault(),"stop";if(3!=r.nodeType&&"BR"!=r.nodeName)return!1;if("BR"==r.nodeName){if(e(r).filter("[_moz_dirty]").length)return"stop";var u=r.previousSibling;if(null==u)return this._setCaretPositionRelative(r,"before"),e(r).remove(),!0;if(3!=u.nodeType)return this._setCaretPositionRelative(r,"before"),e(r).remove(),o.preventDefault(),!0;this._setCaretPositionRelative(u,"end"),e(r).remove()}return d=this._getCaretPosition(),0==(s=this._walkTextNode(d.dom_node,d.offset,"left"))?!1:(i=t.getSelection(),l=n.createRange(),3!=s.dom_node.nodeType?l.setStartAfter(s.dom_node):l.setStart(s.dom_node,s.offset),l.setEnd(d.dom_node,d.offset),l.deleteContents(),i.removeAllRanges(),i.addRange(l),this._saveRange(),!0)},_deleteZeroSpace:function(){var e={},i={},o=null,r=null;return e=this._getCaretPosition(),3!=e.dom_node.nodeType?!1:0==(i=this._walkTextNode(e.dom_node,e.offset,"right"))?!1:e.dom_node===i.dom_node&&e.offset==i.offset?!1:(o=t.getSelection(),r=n.createRange(),r.setStart(e.dom_node,e.offset),3!=i.dom_node.nodeType?r.setEndBefore(i.dom_node):r.setEnd(i.dom_node,i.offset),r.deleteContents(),o.removeAllRanges(),o.addRange(r),this._saveRange(),!0)},_treeWalker:function(t,n,i){for(var o={type:""},r=100,a=!1,s=!1;null!=t;){if(r--<=0)return!1;if(3==t.nodeType){if(0==(o=this._walkTextNode(t,n,i)))return!1;switch(o.type){case"text":if(o.dom_node.nodeValue.length>0)return o.preventDefault=a,o;t="left"==i?o.dom_node.previousSibling:o.dom_node.nextSibling,n=-1;continue;case"element":case"object":t=o.dom_node,n=-1;break;case"container":a=!0,s=!0,n=-1,t=o.dom_node;break;case"end":return!1}}if(this._isEmbeddedObject(t)){var d=!0;return s&&(d=!1),{dom_node:t,offset:-1,type:"object",preventDefault:a,checkForObjects:d}}if("BR"==t.nodeName)return 0!=e(t).filter("[_moz_dirty]").length?{dom_node:t,offset:-1,type:"element",preventDefault:a,checkForObjects:!1}:{dom_node:t,offset:-1,type:"element",preventDefault:a,checkForObjects:!1};if("container"==o.type||"DIV"!=t.nodeName&&"SPAN"!=t.nodeName&&"P"!=t.nodeName){if("left"==i&&null==t.previousSibling||"right"==i&&null==t.nextSibling){if(e(t.parentNode).attr("id")==this.element.attr("id"))return!1;t=t.parentNode}t="left"==i?t.previousSibling:t.nextSibling,o.type=""}else{a=!0,s=!0;var l=t.childNodes;if(0==l.length){var f=this._insertEmptyNode(t,"child");return{dom_node:f,offset:0,type:"child",preventDefault:a,checkForObjects:!1}}var c=null;if(c="left"==i?l[l.length-1]:l[0],3!=c.nodeType&&!this._isEmbeddedObject(c)&&"DIV"!=c.nodeName&&"P"!=c.nodeName&&"BR"!=c.nodeName)return{dom_node:t,offset:-1,type:"child",preventDefault:a,checkForObjects:!1};if(3==c.nodeType&&null!=c.nodeValue.match(/^[\u200B]+$/))return{dom_node:c,offset:0,type:"child",preventDefault:a,checkForObjects:!1};t=c}}return!1},_walkTextNode:function(t,n,i){var o=200;if(3!=t.nodeType)return!1;switch(-1==n&&(n="left"==i?t.nodeValue.length:0),i){case"left":var r=!1;for(0==n&&(r=!0);;){if(o--<=0)return!1;if(r){if(r=!1,null==t.previousSibling)return e(t.parentNode).attr("id")==this.element.attr("id")?{dom_node:t,offset:0,type:"end",preventDefault:!1,checkForObjects:!0}:{dom_node:t.parentNode,offset:-1,type:"container",preventDefault:!1,checkForObjects:!0};if(3!=t.previousSibling.nodeType){t=t.previousSibling;var a=t.nodeName;return"A"===a||"CODE"===a?(t=t.firstChild,{dom_node:t,offset:t.nodeValue.length,type:"text",preventDefault:!1,checkForObjects:!0}):{dom_node:t,offset:-1,type:"element",preventDefault:!1,checkForObjects:!0}}if(t=t.previousSibling,0==(n=t.nodeValue.length)){n=0,r=!0;continue}}if("​"!=t.nodeValue.charAt(n-1))return{dom_node:t,offset:n,type:"text",preventDefault:!1,checkForObjects:!1};n--,0==n&&(r=!0)}return!1;case"right":for(;;){if(o--<=0)return!1;if(n==t.nodeValue.length){if(null==t.nextSibling){if(e(t.parentNode).attr("id")==this.element.attr("id"))return{dom_node:t,offset:n,type:"end",preventDefault:!1,checkForObjects:!1};if(e(t.parentNode).attr("id")==this.element.attr("id")){var s=this._insertEmptyNode(t,"after");return{dom_node:s,offset:0,type:"end",preventDefault:!1,checkForObjects:!0}}return{dom_node:t.parentNode,offset:-1,type:"container",preventDefault:!1,checkForObjects:!0}}if(3!=t.nextSibling.nodeType)return t=t.nextSibling,"A"===t.nodeName||"CODE"===t.nodeName?(t=t.firstChild,{dom_node:t,offset:0,type:"text",preventDefault:!1,checkForObjects:!0}):{dom_node:t,offset:-1,type:"element",preventDefault:!1,checkForObjects:!0};if(t=t.nextSibling,n=0,0==t.nodeValue.length)continue}if("​"!=t.nodeValue.charAt(n))return{dom_node:t,offset:n,type:"text",preventDefault:!1,checkForObjects:!0};n++}return!1}},_highlightObject:function(){},_unHighlightObjects:function(t){var n=this;t.children().each(function(){return n._isEmbeddedObject(e(this).get(0))?void e(this).removeClass("highlight"):void(e(this).children().length>0&&n._unHighlightObjects(e(this)))})},_selectTextNode:function(e,i,o){if(3!=e.nodeType)return!1;var r=t.getSelection(),a=n.createRange();a.setStart(e,i),o||a.setEnd(e,i),a.collapse(!0),r.removeAllRanges(),r.addRange(a),this._saveRange(a),o&&this.element.focus()},_setCaretPositionRelative:function(n,i){var o=t.getSelection(),r=null;if(this._isEmbeddedObject(n)){switch(r=this._getObjectRange(n),i){case"before":case"beginning":r.collapse(!0);break;case"after":case"end":r.collapse(!1)}return o.removeAllRanges(),o.addRange(r),void this._saveRange()}switch(r=o.getRangeAt(0),i){case"before":if("BR"==n.nodeName){var a=this._insertEmptyNode(n,"before");return void this._setCaretPositionRelative(a,"end")}r.setStartBefore(n),r.setEndBefore(n),r.collapse(!0),o.removeAllRanges(),o.addRange(r),this._saveRange();break;case"after":if("BR"==n.nodeName){r.setStartBefore(n),r.setEndBefore(n),r.collapse(!1),o.removeAllRanges(),o.addRange(r),this._saveRange();break}r.setStartAfter(n),r.setEndAfter(n),r.collapse(!1),o.removeAllRanges(),o.addRange(r),this._saveRange();break;case"beginning":if(3!=n.nodeType)return;r.setStart(n,0),r.setEnd(n,0),r.collapse(!1),o.removeAllRanges(),o.addRange(r),this._saveRange();break;case"end":if(3!=n.nodeType)return;r.setStart(n,n.nodeValue.length),r.setEnd(n,n.nodeValue.length),r.collapse(!1),o.removeAllRanges(),o.addRange(r),this._saveRange()}if("DIV"==r.startContainer.nodeName&&e(r.startContainer).attr("id")==this.element.attr("id")&&r.startOffset==r.startContainer.childNodes.length){var a=this._insertEmptyNode(r.startContainer,"child");this._selectTextNode(a,0)}},_getObjectRange:function(e){var t=i.getRangeAt(0),o=null;if(i.rangeCount){var r=e.previousSibling;if(null==r){var a=this._insertEmptyNode(e,"before");t.setStart(a,0)}else if(3!=r.nodeType){var a=this._insertEmptyNode(e,"before");t.setStart(a,0)}else if(null==r.nodeValue){var a=this._insertEmptyNode(e,"before");t.setStart(a,0)}else if(0==r.nodeValue.length){var a=this._insertEmptyNode(e,"before");t.setStart(a,0)}else t.setStart(r,r.nodeValue.length);o=n.createRange();var s=e.nextSibling;if(null==s){var a=this._insertEmptyNode(e,"after");t.setEnd(a,1)}else if(3!=s.nodeType){var a=this._insertEmptyNode(e,"after");t.setEnd(a,1)}else if(null==s.nodeValue){var a=this._insertEmptyNode(e,"after");t.setEnd(a,1)}else if(0==s.nodeValue.length){var a=this._insertEmptyNode(e,"after");t.setEnd(a,1)}else if("​"!=s.nodeValue){var a=this._insertEmptyNode(e,"after");t.setEnd(a,1)}else t.setEnd(s,1);return t}},_getCaretPosition:function(){var n=null,i=null,o=null;try{var r=t.getSelection().getRangeAt(0)}catch(e){return!1}if(!r.collapsed)return!1;if(n=r.startContainer,o=this._isEmbeddedObject(n))return{dom_node:o,offset:-1};if(3==n.nodeType)return{dom_node:n,offset:r.startOffset};if(e(n).attr("id")==this.element.attr("id")||"DIV"==n.nodeName||"P"==n.nodeName){if(0==n.childNodes.length)return i=this._insertEmptyNode(n,"child"),this._selectTextNode(i,0),{dom_node:i,offset:0};if(r.startOffset>=n.childNodes.length)return i=this._insertEmptyNode(n,"after"),this._selectTextNode(i,1),{dom_node:i,offset:1};if(n=n.childNodes[r.startOffset],3==n.nodeType)return this._selectTextNode(n,0),{dom_node:n,offset:0}}return{dom_node:n,offset:-1}},_insertSelection:function(e,t){this.replaceWord(e,t.content,t.value),this.selectionEntered=!0},replaceWord:function(e,t,i){var o=n.createRange();o.setStart(e.startNode,e.startOffset),o.setEnd(e.endNode,e.endOffset),o.deleteContents(),this._saveRange(o),this.insertObject(t,i)},_insertEmptyNode:function(t,n,i){"undefined"==typeof i&&(i=!1);var o=document.createTextNode("​");switch(n){case"before":if(!i&&null!=t.previousSibling&&3==t.previousSibling.nodeType&&t.previousSibling.nodeValue.length>0)return t.previousSibling;e(o).insertBefore(t);break;case"after":if(!i&&null!=t.nextSibling&&3==t.nextSibling.nodeType&&t.nextSibling.nodeValue.length>0)return t.nextSibling;e(o).insertAfter(t);break;case"child":var r=t.childNodes,a=r.length;if(a&&3==r[a-1].nodeType)return r[a-1];e(o).appendTo(t)}return o},_checkSibling:function(t,n){var i=null;if(i="prev"==n?t.previousSibling:t.nextSibling,null!=i){if(this._isEmbeddedObject(i))return this._insertEmptyNode(i,"before"),void this._insertEmptyNode(i,"after");if("BR"==i.nodeName)return this._insertEmptyNode(i,"before"),void this._insertEmptyNode(i,"after");if("SPAN"==i.nodeName||"DIV"==i.nodeName||"P"==i.nodeName){var o=i.childNodes,r=o.length;if(0==r)return void this._insertEmptyNode(i,"child");if(1==r&&"BR"==o[0].nodeName){var a=o[0];return this._insertEmptyNode(a,"before"),void e(a).remove()}this._insertEmptyNode(o[0],"before"),this._insertEmptyNode(o[r-1],"after")}}},_isEmbeddedObject:function(t){return null==t?!1:null!=e(t).attr("data-value")?null!=e(t).parent().attr("data-value")?e(t).parent()[0]:t:!1},insertObject:function(n,i){if(this.element.focus(),!this.currentRange){var o=this._insertEmptyNode(this.element.get(0),"child");this._selectTextNode(o,1)}var r=t.getSelection(),a=this.currentRange;r.removeAllRanges(),r.addRange(a);var s=document.createElement("div");s.innerHTML=n.replace(/^[\s\u200B]+|[\s\u200B]+$/g,""),node=e(s).contents(),node.attr("data-value",i).attr("class","highlight");var d=node.get(0);a.insertNode(d),a.setStartAfter(d),a.collapse(!0),r.removeAllRanges(),r.addRange(a);var o=this._insertEmptyNode(d,"before",!0),l=this._insertEmptyNode(d,"after",!0);this._selectTextNode(l,1,!0)},getTextContent:function(){var e=this._getTextWithLineBreaks(this.element.get(0).childNodes);return e=e.replace(/[\u200B]/gm,"")},_getTextWithLineBreaks:function(t){for(var n,i=["BR","DIV","P"],o="",r=0;t[r];r++)n=t[r],this._isEmbeddedObject(n)?o+="[o="+e(n).attr("data-value")+"]":(3==n.nodeType||4==n.nodeType?o+=n.nodeValue.replace(/[\n]/gm,""):-1!=e.inArray(n.nodeName,i)&&(o+="\n"),8!==n.nodeType&&(o+=this._getTextWithLineBreaks(n.childNodes)));return o},clear:function(){this.element.empty()},focus:function(){var e=n.createRange();e.setStart(this.element.get(0),0),this.element.focus()}})}(jQuery);